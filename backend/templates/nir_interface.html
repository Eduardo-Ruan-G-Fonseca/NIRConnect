<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma NIR para Aplicações Florestais</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pDEDr8vFRNbfS/laxzZMObhXyc6s+v1SRFUozLgWrp20y+9QVE9PXQimH1wN4MD6aqDHFqUxu+1PIo4wF7X1Yg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Plotly JS -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js" defer></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-[#f8f9fa] text-gray-800">
<div class="max-w-2xl mx-auto p-4 space-y-6">
    <!-- Título -->
    <header class="text-center space-y-1">
        <h1 class="text-3xl font-semibold text-[#2e5339]">Plataforma NIR para Aplicações Florestais</h1>
        <p class="text-lg text-[#305e6b]">Modelagem de Propriedades da Madeira via Espectroscopia NIR</p>
    </header>

    <!-- Indicador de Progresso -->
    <nav class="text-sm text-gray-500 flex justify-between" id="progressBar">
        <span class="step font-semibold text-green-700">1. Upload</span>
        <span class="step">2. Parâmetros</span>
        <span class="step">3. Pré-processamento</span>
        <span class="step">4. Tomada de Decisão</span>
        <span class="step">5. Resultado</span>
    </nav>

    <!-- Etapa 1 -->
    <div id="etapa1" class="etapa bg-white rounded-lg shadow p-6 overflow-hidden transition-all duration-300">
        <form id="formEtapa1" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Upload de Arquivo (.csv ou .xlsx)</label>
                <input type="file" id="file" accept=".csv,.xlsx" required class="mt-1 block w-full border rounded p-2" />
            </div>
            <div id="progressContainer" class="hidden w-full bg-gray-200 rounded">
                <div id="progressBarInner" class="h-2 bg-green-500 w-0 transition-all"></div>
            </div>
            <div class="flex items-center space-x-2 mt-1">
                <span id="progressPercent" class="text-sm hidden">0%</span>
                <span id="uploadStatus" class="text-sm text-gray-600 hidden"></span>
            </div>
            <button id="submitStep1" type="submit" class="bg-[#2e5339] hover:bg-[#305e6b] text-white py-2 px-4 rounded">Avançar</button>
        </form>
    </div>

    <!-- Etapa 2 -->
    <div id="etapa2" class="etapa hidden opacity-0 translate-x-full bg-white rounded-lg shadow p-6 overflow-hidden transition-all duration-300">
        <form id="formEtapa2" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Variável-alvo <span class="text-xs text-gray-500">Ex: densidade, teor de lignina</span></label>
                <select id="target" class="mt-1 block w-full border rounded p-2"></select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nº de Componentes</label>
                    <input type="number" id="n_components" value="5" min="1" class="mt-1 w-full border rounded p-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700" for="classification">Modo de Análise</label>
                    <select id="classification" class="mt-1 block w-full border rounded p-2">
                        <option value="false" selected>Regressão (PLS-R)</option>
                        <option value="true">Classificação (PLS-DA)</option>
                    </select>
                </div>
                <div id="thresholdContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Threshold de classificação (0.00–1.00)</label>
                    <input type="number" id="cls_threshold" value="0.5" min="0" max="1" step="0.01" class="mt-1 w-full border rounded p-2" />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 flex items-center">Nº de bootstrap
                        <span class="ml-1 text-gray-500 cursor-help" title="Bootstrap é um método estatístico de reamostragem para estimar a variabilidade dos modelos. Use valores entre 50 e 200 para estabilidade. Coloque 0 para desativar.">ℹ️</span>
                    </label>
                    <input type="number" id="n_bootstrap" value="0" min="0" class="mt-1 w-full border rounded p-2" />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Método de Validação</label>
                    <select id="validation_method" class="mt-1 block w-full border rounded p-2">
                        <option value="KFold" selected>K-Fold</option>
                        <option value="LOO">Leave-One-Out (LOO)</option>
                        <option value="Holdout">Train/Test Split</option>
                    </select>
                </div>
                <div id="kfoldContainer" class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Número de folds (k)</label>
                    <input type="number" id="kfold_splits" value="5" min="2" class="mt-1 w-full border rounded p-2" />
                </div>
                <div id="holdoutContainer" class="md:col-span-2 hidden">
                    <label class="block text-sm font-medium text-gray-700">Proporção de teste</label>
                    <input type="number" id="test_size" value="0.3" step="0.05" min="0.1" max="0.9" class="mt-1 w-full border rounded p-2" />
                </div>
            </div>
            <button id="submitStep2" type="submit" class="bg-[#2e5339] hover:bg-[#305e6b] text-white py-2 px-4 rounded">Próximo</button>
        </form>
    </div>

    <!-- Etapa 3 -->
    <div id="etapa3" class="etapa hidden opacity-0 translate-x-full bg-white rounded-lg shadow p-6 overflow-hidden transition-all duration-300">
        <form id="uploadForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Selecione faixas espectrais</label>
                <p class="text-xs text-gray-600">Selecione com o mouse a faixa espectral desejada para processamento (ex: 950–1650 nm).</p>
                <div id="spectraChart" class="w-full h-80 mt-2"></div>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-700">λ_min</label>
                        <input type="number" id="lambdaMin" class="mt-1 w-full border rounded p-1 text-sm" />
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700">λ_max</label>
                        <input type="number" id="lambdaMax" class="mt-1 w-full border rounded p-1 text-sm" />
                    </div>
                </div>
                <label class="flex items-center text-sm mt-2"><input type="checkbox" id="showMean" class="mr-2" checked>Exibir espectro médio</label>
                <input type="hidden" id="ranges" />
                <p id="rangesSummary" class="text-sm mt-2 text-gray-700"></p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Pré-processamento Espectral</label>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <label class="flex items-center"><input type="checkbox" name="preprocess" value="snv" class="mr-2">SNV</label>
                    <label class="flex items-center"><input type="checkbox" name="preprocess" value="msc" class="mr-2">MSC</label>
                    <label class="flex items-center"><input type="checkbox" name="preprocess" value="sg1" class="mr-2">1ª derivada SG</label>
                    <label class="flex items-center"><input type="checkbox" name="preprocess" value="sg2" class="mr-2">2ª derivada SG</label>
                    <label class="flex items-center"><input type="checkbox" name="preprocess" value="minmax" class="mr-2">Normalização min-max</label>
                    <label class="flex items-center"><input type="checkbox" name="preprocess" value="zscore" class="mr-2">Padronização z-score</label>
                </div>
                <div id="derivParams" class="grid grid-cols-2 gap-2 text-sm mt-2 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Janela de suavização</label>
                        <input type="number" id="windowLength" value="11" min="3" step="2" class="mt-1 w-full border rounded p-2" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Ordem do polinômio</label>
                        <input type="number" id="polyOrder" value="2" min="1" class="mt-1 w-full border rounded p-2" />
                    </div>
                </div>
            </div>
            <button id="runButton" type="submit" class="w-full bg-[#2e5339] hover:bg-[#305e6b] text-white py-2 rounded flex items-center justify-center">
                <i class="fas fa-chart-line mr-2"></i><span id="runText">Executar Calibração</span>
            </button>
        </form>
    </div>

    <!-- Etapa 4 - Tomada de Decisão -->
    <div id="etapa4" class="etapa hidden opacity-0 translate-x-full space-y-6">
        <h2 class="text-xl font-semibold text-[#305e6b] flex items-center"><i class="fas fa-balance-scale mr-2"></i>Tomada de Decisão</h2>
        <div id="optProgressContainer" class="hidden w-full bg-gray-200 rounded">
            <div id="optProgressBar" class="h-2 bg-green-500 w-0 transition-all"></div>
        </div>
        <div id="optProgress" class="text-sm text-gray-700 mt-1"></div>
        <div class="overflow-auto">
            <table class="min-w-full text-sm" id="decisionTable"></table>
        </div>
        <div id="decisionChart" class="w-full h-80 mt-4"></div>
        <button id="continueModel" class="bg-[#2e5339] hover:bg-[#305e6b] text-white py-2 px-4 rounded">Continuar</button>
    </div>

    <!-- Etapa 5 -->
    <div id="etapa5" class="etapa hidden opacity-0 translate-x-full space-y-6">
        <section id="results" class="space-y-6">
            <h2 class="text-xl font-semibold text-[#305e6b] flex items-center"><i class="fas fa-chart-bar mr-2"></i>Resultados da Modelagem</h2>
            <p id="validationInfo" class="text-sm text-gray-700"></p>

            <div id="metricsCard" class="bg-white rounded-lg shadow-md p-4 overflow-hidden">
                <h3 class="text-lg font-semibold mb-2">Métricas Gerais</h3>
                <div class="overflow-auto">
                    <table class="min-w-full text-sm" id="metricsTable">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 border-b text-left">Métrica</th>
                                <th class="px-4 py-2 border-b text-left">Valor</th>
                            </tr>
                        </thead>
                    <tbody id="metrics"></tbody>
                </table>
            </div>
        </div>
        <p id="sensitivityDesc" class="text-xs text-gray-600 hidden"></p>

        <div id="classReportCard" class="bg-white rounded-lg shadow-md p-4 overflow-hidden hidden">
                <h3 class="text-lg font-semibold mb-2">Relatório de Classificação</h3>
                <div id="classReport" class="max-h-80 overflow-y-auto border rounded p-2 text-sm font-mono whitespace-pre"></div>
            </div>

            <div id="confMatrixCard" class="bg-white rounded-lg shadow-md p-4 overflow-hidden hidden">
                <h3 class="text-lg font-semibold mb-2">Matriz de Confusão</h3>
                <div id="confMatrix" class="w-full h-80 mt-2"></div>
            </div>

            <div id="scoresCard" class="bg-white rounded-lg shadow-md p-4 overflow-hidden hidden">
                <h3 class="text-lg font-semibold mb-2">Scores PLS</h3>
                <div id="realVsPred" class="w-full h-80 mt-2"></div>
            </div>

            <div id="vipCard" class="bg-white rounded-lg shadow-md p-4 overflow-hidden">
                <h3 class="text-lg font-semibold mb-2">VIP Scores</h3>
                <div id="vipChart" class="w-full h-80 mt-2"></div>
            </div>

            <button id="downloadPdf" class="mt-4 bg-[#2e5339] hover:bg-[#305e6b] text-white py-2 px-4 rounded flex items-center"><i class="fas fa-download mr-2"></i>Baixar Relatório PDF</button>

            <div id="optBlock" class="mt-6 space-y-2">
                <p class="text-sm">Deseja otimizar o modelo?</p>
                <button id="optimizeButton" type="button" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded flex items-center"><i class="fas fa-cogs mr-2"></i>Otimizar Modelo</button>
            </div>
        </section>

        <section id="interpretation" class="bg-white rounded-lg shadow p-6 overflow-hidden hidden">
            <h2 class="text-xl font-semibold text-[#305e6b] flex items-center mb-4"><i class="fas fa-lightbulb mr-2"></i>Interpretação do Modelo</h2>
            <p id="rangeUsed" class="text-sm text-gray-600 mb-2"></p>
            <div class="overflow-auto">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr><th class="px-4 py-2 border-b text-left">λ (nm)</th><th class="px-4 py-2 border-b text-left">VIP</th><th class="px-4 py-2 border-b text-left">Associação</th></tr>
                    </thead>
                    <tbody id="vipTableBody"></tbody>
                </table>
            </div>
        </section>
        <button id="newAnalysis" class="bg-[#2e5339] hover:bg-[#305e6b] text-white py-2 px-4 rounded">Nova análise</button>
    </div>
</div>

<script>
let currentMetrics = null;
let meanSpectra = null;
let allSpectra = null;
let selectedRanges = [];
let selectedOpt = null;
const fileInput = document.getElementById('file');
const targetSelect = document.getElementById('target');
const submitStep2Btn = document.getElementById('submitStep2');
const etapas = [
    document.getElementById('etapa1'),
    document.getElementById('etapa2'),
    document.getElementById('etapa3'),
    document.getElementById('etapa4'),
    document.getElementById('etapa5')
];
const stepsIndicator = document.querySelectorAll('#progressBar .step');
let etapaAtual = 0;

function mostrarEtapa(n){
    etapas.forEach((el,i)=>{
        if(i===n){
            el.classList.remove('hidden');
            setTimeout(()=>{
                el.classList.remove('opacity-0','translate-x-full');
                el.classList.add('opacity-100','translate-x-0');
            },10);
        } else {
            el.classList.add('hidden','opacity-0','translate-x-full');
        }
    });
    stepsIndicator.forEach((el,i)=>{
        if(i<=n){
            el.classList.add('text-green-700','font-semibold');
        } else {
            el.classList.remove('text-green-700','font-semibold');
        }
    });
    etapaAtual = n;
    if(n===2){
        renderSpectraChart();
    }
}
let lastParams = null;
let lastVip = null;
let lastYReal = null;
let lastYPred = null;
let lastTopVips = null;
let lastScores = null;
let lastInterpretacao = null;
let lastResumo = null;
let preprocessOrder = [];
const preprocessLabels = {
    snv: 'SNV',
    msc: 'MSC',
    sg1: '1ª Derivada',
    sg2: '2ª Derivada',
    minmax: 'Normalização Min-Max',
    zscore: 'Z-score'
};

mostrarEtapa(0);
if(submitStep2Btn) submitStep2Btn.disabled = true;
const showMeanCb = document.getElementById('showMean');
if(showMeanCb) showMeanCb.addEventListener('change', ()=>renderSpectraChart());
const lambdaMinInput = document.getElementById('lambdaMin');
const lambdaMaxInput = document.getElementById('lambdaMax');
if(lambdaMinInput) lambdaMinInput.addEventListener('change', updateRangesSummary);
if(lambdaMaxInput) lambdaMaxInput.addEventListener('change', updateRangesSummary);
const clsSelect = document.getElementById('classification');
const thresholdContainer = document.getElementById('thresholdContainer');
if(clsSelect){
    clsSelect.addEventListener('change', ()=>{
        if(clsSelect.value === 'true'){
            thresholdContainer.classList.remove('hidden');
        }else{
            thresholdContainer.classList.add('hidden');
        }
    });
}

const valSelect = document.getElementById('validation_method');
const kfoldContainer = document.getElementById('kfoldContainer');
const holdoutContainer = document.getElementById('holdoutContainer');
if(valSelect){
    const updateValUI = ()=>{
        if(valSelect.value === 'KFold'){
            kfoldContainer.classList.remove('hidden');
            holdoutContainer.classList.add('hidden');
        }else if(valSelect.value === 'Holdout'){
            kfoldContainer.classList.add('hidden');
            holdoutContainer.classList.remove('hidden');
        }else{
            kfoldContainer.classList.add('hidden');
            holdoutContainer.classList.add('hidden');
        }
    };
    valSelect.addEventListener('change', updateValUI);
    updateValUI();
}

const derivContainer = document.getElementById('derivParams');
document.querySelectorAll('input[name="preprocess"]').forEach(cb => {
    cb.addEventListener('change', () => {
        preprocessOrder = preprocessOrder.filter(o => o.method !== cb.value);
        if (cb.checked) {
            preprocessOrder.push({method: cb.value});
        }
        if(['sg1','sg2'].includes(cb.value)){
            const anyDeriv = Array.from(document.querySelectorAll('input[name="preprocess"]'))
                .some(c => c.checked && ['sg1','sg2'].includes(c.value));
            if(anyDeriv){
                derivContainer.classList.remove('hidden');
            }else{
                derivContainer.classList.add('hidden');
            }
        }
    });
});

document.getElementById('formEtapa1').addEventListener('submit', (e)=>{
    e.preventDefault();
    if(!fileInput.files.length) return;
    const file = fileInput.files[0];
    const ext = file.name.split('.').pop().toLowerCase();
    if(!['csv','xlsx'].includes(ext)){
        alert('Arquivo deve ser .csv ou .xlsx');
        return;
    }
    if(file.size > 100 * 1024 * 1024){
        alert('Arquivo excede o limite de 100MB.');
        return;
    }
    const progressBar = document.getElementById('progressBarInner');
    const progressCont = document.getElementById('progressContainer');
    const progressText = document.getElementById('progressPercent');
    const statusEl = document.getElementById('uploadStatus');
    const btn = document.getElementById('submitStep1');
    progressCont.classList.remove('hidden');
    progressBar.style.width = '0%';
    progressText.textContent = '0%';
    progressText.classList.remove('hidden');
    statusEl.textContent = 'Enviando arquivo... Aguarde.';
    statusEl.classList.remove('hidden');
    btn.disabled = true;
    const fd = new FormData();
    fd.append('file', file);
    const xhr = new XMLHttpRequest();
    xhr.open('POST','/columns');
    xhr.upload.addEventListener('progress', (ev)=>{
        if(ev.lengthComputable){
            const pct = Math.round((ev.loaded/ev.total)*100);
            progressBar.style.width = pct+'%';
            progressText.textContent = pct+'%';
        }
    });
    xhr.onload = async () => {
        if(xhr.status === 200){
            progressBar.style.width = '100%';
            progressText.textContent = '100%';
            statusEl.textContent = 'Arquivo enviado com sucesso! Prossiga para configurar a análise.';
            try{
                const meta = JSON.parse(xhr.responseText);
                if(meta && meta.targets && meta.targets.length){
                    targetSelect.innerHTML = meta.targets.map(c=>`<option value="${c}">${c}</option>`).join('');
                    document.getElementById('submitStep2').disabled = false;
                    statusEl.textContent = 'Arquivo enviado com sucesso! Prossiga para configurar a análise.';
                }else{
                    targetSelect.innerHTML = '';
                    document.getElementById('submitStep2').disabled = true;
                    statusEl.textContent = 'Erro ao ler as colunas da planilha. Verifique se o arquivo contém um cabeçalho válido na primeira linha.';
                }
                if(meta && meta.mean_spectra){
                    meanSpectra = meta.mean_spectra;
                }
                if(meta && meta.spectra_matrix){
                    allSpectra = meta.spectra_matrix;
                }
                selectedRanges = [];
            }catch(e){
                statusEl.textContent = 'Erro ao ler as colunas da planilha. Verifique se o arquivo contém um cabeçalho válido na primeira linha.';
                document.getElementById('submitStep2').disabled = true;
            }
            btn.disabled = false;
            setTimeout(()=> mostrarEtapa(1),300);
        }else{
            statusEl.textContent = 'Erro ao enviar. O arquivo est\xE1 corrompido, em formato inv\xE1lido ou excede 100MB.';
            btn.disabled = false;
        }
    };
    xhr.onerror = () => {
        statusEl.textContent = 'Erro ao enviar. O arquivo est\xE1 corrompido, em formato inv\xE1lido ou excede 100MB.';
        btn.disabled = false;
    };
    xhr.send(fd);
});

document.getElementById('formEtapa2').addEventListener('submit',(e)=>{
    e.preventDefault();
    if(!targetSelect.value) return;
    selectedRanges = [];
    mostrarEtapa(2);
});
fileInput.addEventListener('change', async () => {
    if(!fileInput.files.length) return;
    const fd = new FormData();
    fd.append('file', fileInput.files[0]);
    const res = await fetch('/columns', {method:'POST', body:fd});
    if(res.ok){
        const meta = await res.json();
        if(meta && meta.targets && meta.targets.length){
            targetSelect.innerHTML = meta.targets.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('submitStep2').disabled = false;
        }else{
            targetSelect.innerHTML = '';
            document.getElementById('submitStep2').disabled = true;
            alert('Erro ao ler as colunas da planilha. Verifique se o arquivo contém um cabeçalho válido na primeira linha.');
        }
        if(meta.mean_spectra) meanSpectra = meta.mean_spectra;
        if(meta.spectra_matrix) allSpectra = meta.spectra_matrix;
    }else{
        targetSelect.innerHTML = '';
        document.getElementById('submitStep2').disabled = true;
        alert('Erro ao ler as colunas da planilha. Verifique se o arquivo contém um cabeçalho válido na primeira linha.');
    }
    selectedRanges = [];
});

function renderMetrics(metrics) {
    const body = document.getElementById('metrics');
    body.innerHTML = '';
    const classCard = document.getElementById('classReportCard');
    const classDiv = document.getElementById('classReport');
    const confCard = document.getElementById('confMatrixCard');
    const sensDesc = document.getElementById('sensitivityDesc');
    classCard.classList.add('hidden');
    confCard.classList.add('hidden');
    classDiv.textContent = '';
    sensDesc.classList.add('hidden');
    sensDesc.textContent = '';

    for (const [key, value] of Object.entries(metrics || {})) {
        const lower = key.toLowerCase();
        if (lower.includes('confusion')) {
            if (value) confCard.classList.remove('hidden');
            continue;
        }
        if (lower.includes('report') && value) {
            classCard.classList.remove('hidden');
            classDiv.textContent = typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value);
            continue;
        }
        if (lower.includes('sensitivity_per_class') && typeof value === 'object') {
            for (const [cls, val] of Object.entries(value)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-4 py-2 border-b font-semibold">Sensibilidade ${cls}</td>`+
                               `<td class="px-4 py-2 border-b">${Number(val).toFixed(4)}</td>`;
                body.appendChild(tr);
            }
            continue;
        }
        if (typeof value === 'object') continue;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-4 py-2 border-b font-semibold">${key}</td>`+
                       `<td class="px-4 py-2 border-b">${isFinite(value) ? Number(value).toFixed(4) : value}</td>`;
        body.appendChild(tr);
    }

    if (metrics && metrics.SensitivityDescription) {
        sensDesc.textContent = metrics.SensitivityDescription;
        sensDesc.classList.remove('hidden');
    }
}

function renderTopVips(data, rangeUsed){
    const body = document.getElementById('vipTableBody');
    const rangeEl = document.getElementById('rangeUsed');
    body.innerHTML = '';
    rangeEl.textContent = rangeUsed ? `Faixa utilizada: ${rangeUsed}` : '';
    data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-4 py-2 border-b">${item.wavelength}</td>`+
                        `<td class="px-4 py-2 border-b">${item.vip.toFixed ? item.vip.toFixed(2) : item.vip}</td>`+
                        `<td class="px-4 py-2 border-b">${item.label || ''}</td>`;
        body.appendChild(tr);
    });
    document.getElementById('interpretation').classList.remove('hidden');
}

function renderSpectraChart(){
    const div = document.getElementById('spectraChart');
    if(!div || !allSpectra || !allSpectra.wavelengths.length) return;
    const traces = allSpectra.values.map(v => ({
        x: allSpectra.wavelengths,
        y: v,
        mode:'lines',
        type:'scatter',
        line:{color:'#888', width:1},
        opacity:0.1,
        hoverinfo:'skip'
    }));
    const showMean = document.getElementById('showMean');
    if(showMean && showMean.checked && meanSpectra){
        traces.push({x: meanSpectra.wavelengths, y: meanSpectra.values, mode:'lines', type:'scatter', line:{color:'red', width:2}});
    }
    const shapes = selectedRanges.map(r => ({
        type:'rect', xref:'x', yref:'paper', x0:r[0], x1:r[1], y0:0, y1:1,
        fillcolor:'rgba(0,200,0,0.2)', line:{width:0}
    }));
    Plotly.newPlot(div, traces, {dragmode:'select', shapes}, {responsive:true});
    div.on('plotly_selected', ev => {
        if(ev && ev.range && ev.range.x){
            const start = Math.round(ev.range.x[0]);
            const end = Math.round(ev.range.x[1]);
            if(start !== end){
                document.getElementById('lambdaMin').value = Math.min(start,end);
                document.getElementById('lambdaMax').value = Math.max(start,end);
                updateRangesSummary();
            }
        }
        Plotly.relayout(div, {dragmode:'select'});
    });
    updateRangesSummary();
}

function updateRangesSummary(){
    const input = document.getElementById('ranges');
    const summary = document.getElementById('rangesSummary');
    const lmin = document.getElementById('lambdaMin').value;
    const lmax = document.getElementById('lambdaMax').value;
    selectedRanges = [];
    if(lmin && lmax){
        const a = Number(lmin);
        const b = Number(lmax);
        if(!isNaN(a) && !isNaN(b) && a !== b){
            selectedRanges.push([Math.min(a,b), Math.max(a,b)]);
        }
    }
    const text = selectedRanges.map(r => `${r[0]}-${r[1]}`).join(',');
    input.value = text;
    summary.textContent = text ? `Faixas selecionadas: ${selectedRanges.map(r => `${r[0]}–${r[1]} nm`).join(' e ')}` : 'Nenhuma faixa selecionada';
    const shapes = selectedRanges.map(r => ({
        type:'rect', xref:'x', yref:'paper', x0:r[0], x1:r[1], y0:0, y1:1,
        fillcolor:'rgba(0,200,0,0.2)', line:{width:0}
    }));
    Plotly.relayout('spectraChart', {shapes});
    const runButton = document.getElementById('runButton');
    if(runButton) runButton.disabled = selectedRanges.length === 0;
}

document.getElementById('uploadForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn = document.getElementById('runButton');
    const runText = document.getElementById('runText');
    if(!targetSelect.value || !fileInput.files.length){
        alert('Selecione a variável-resposta (target) e envie um arquivo válido.');
        return;
    }
    const nCompVal = parseInt(document.getElementById('n_components').value);
    if(isNaN(nCompVal) || nCompVal <= 0){
        alert('Número de componentes inválido.');
        return;
    }
    btn.disabled = true; runText.textContent = 'Carregando...';
    const fd = new FormData();
    fd.append('file', fileInput.files[0]);
    fd.append('target', targetSelect.value);
    fd.append('n_components', nCompVal);
    const clsVal = document.getElementById('classification').value;
    fd.append('classification', clsVal);
    if(clsVal === 'true'){
        fd.append('threshold', document.getElementById('cls_threshold').value);
    }
    fd.append('n_bootstrap', document.getElementById('n_bootstrap').value);
    const valMethod = document.getElementById('validation_method').value;
    fd.append('validation_method', valMethod);
    let valDisplay = 'Validação por K-Fold (k=5)';
    if(valMethod === 'Holdout'){
        const ts = parseFloat(document.getElementById('test_size').value);
        fd.append('validation_params', JSON.stringify({test_size: ts}));
        valDisplay = `Train/Test Split (${Math.round((1-ts)*100)}/${Math.round(ts*100)})`;
    } else if(valMethod === 'KFold') {
        const k = parseInt(document.getElementById('kfold_splits').value) || 5;
        fd.append('validation_params', JSON.stringify({n_splits: k, shuffle: true, random_state: 42}));
        valDisplay = `Validação por K-Fold (k=${k})`;
    } else if(valMethod === 'LOO') {
        valDisplay = 'Leave-One-Out (LOO)';
    }
    const rangesVal = document.getElementById('ranges').value;
    if(!rangesVal){
        alert('Selecione ao menos uma faixa espectral.');
        btn.disabled = false; runText.textContent = 'Executar Calibração';
        return;
    }
    fd.append('spectral_ranges', rangesVal);
    const wlVal = parseInt(document.getElementById('windowLength').value);
    const poVal = parseInt(document.getElementById('polyOrder').value);
    const methods = preprocessOrder.map(step => {
        if(['sg1','sg2'].includes(step.method)){
            return {method: step.method, params:{window_length: wlVal, polyorder: poVal}};
        }
        return {method: step.method};
    });
    if(methods.length) fd.append('preprocess', JSON.stringify(methods));
    const res = await fetch('/analisar', {method:'POST', body:fd});
    if(!res.ok){
        let msg = 'Erro desconhecido';
        try{ const err = await res.json(); msg = err.detail || msg; }catch(e){}
        alert('Erro: '+msg);
        btn.disabled = false; runText.textContent = 'Executar Calibração';
        return;
    }
    const data = await res.json();
    currentMetrics = data.metrics;
    lastVip = data.vip;
    lastYReal = data.y_real;
    lastYPred = data.y_pred;
    lastTopVips = data.top_vips;
    lastScores = data.scores;
    lastInterpretacao = data.interpretacao_vips;
    lastResumo = data.resumo_interpretativo;
    const methodNames = methods.map(m => m.method);
    lastParams = {
        file: fileInput.files[0].name,
        target: targetSelect.value,
        n_components: document.getElementById('n_components').value,
        preprocess: methodNames.join(','),
        preprocess_list: methods.map(m => {
            const label = preprocessLabels[m.method] || m.method;
            if(['sg1','sg2'].includes(m.method)){
                return `${label} (w=${m.params.window_length}, p=${m.params.polyorder})`;
            }
            return label;
        }),
        preprocess_steps: methods,
        ranges: rangesVal,
        range_used: data.range_used,
        validation_method: valMethod,
        validation_params: valMethod === 'Holdout'
            ? {test_size: parseFloat(document.getElementById('test_size').value)}
            : (valMethod === 'KFold' ? {n_splits: parseInt(document.getElementById('kfold_splits').value) || 5} : {}),
        validation_display: valDisplay,
        algorithm: data.analysis_type === 'PLS-DA' ? 'PLS-DA' : 'PLSR',
        analysis_type: data.analysis_type,
        threshold: document.getElementById('cls_threshold').value,
        user: 'Usuário',
        class_mapping: data.class_mapping || null
    };
    renderMetrics(data.metrics);
    const scoresCard = document.getElementById('scoresCard');
    const confCard = document.getElementById('confMatrixCard');
    scoresCard.classList.add('hidden');
    confCard.classList.add('hidden');
    document.getElementById('realVsPred').innerHTML = '';
    document.getElementById('confMatrix').innerHTML = '';
    if(data.analysis_type === 'PLS-DA' && data.scores){
        scoresCard.classList.remove('hidden');
        const xs = data.scores.map(s => s[0]);
        const ys = data.scores.map(s => s[1] || 0);
        const trace = {
            x: xs,
            y: ys,
            mode:'markers',
            type:'scatter',
            marker:{color: data.y_real}
        };
        Plotly.newPlot('realVsPred', [trace], {title:'Scores PLS', xaxis:{title:'Comp 1'}, yaxis:{title:'Comp 2'}}, {responsive:true});
        if(data.metrics && data.metrics.ConfusionMatrix){
            confCard.classList.remove('hidden');
            const labels = data.class_mapping ? Object.values(data.class_mapping) : [];
            const z = data.metrics.ConfusionMatrix;
            const heat = {
                z,
                x: labels,
                y: labels,
                type:'heatmap',
                colorscale:'YlGnBu',
                text: z.map(r => r.map(String)),
                texttemplate:'%{text}',
                textfont:{color:'black'}
            };
            const layout = {title:'Matriz de Confusão', xaxis:{title:'Predito'}, yaxis:{title:'Real'}};
            Plotly.newPlot('confMatrix', [heat], layout, {responsive:true});
        }
    } else if(data.y_real && data.y_pred){
        scoresCard.classList.remove('hidden');
        const scatter = {x: data.y_real, y: data.y_pred, mode:'markers', type:'scatter'};
        Plotly.newPlot('realVsPred', [scatter], {title:'y_real vs y_previsto', xaxis:{title:'y_real'}, yaxis:{title:'y_previsto'}}, {responsive:true});
    }
    const trace = {x: data.features, y: data.vip, type:'bar'};
    Plotly.newPlot('vipChart', [trace], {title:'VIP Scores'}, {responsive:true});
    if(data.top_vips) renderTopVips(data.top_vips, data.range_used);
    document.getElementById('results').classList.remove('hidden');
    document.getElementById('validationInfo').textContent = valDisplay;
    btn.disabled = false; runText.textContent = 'Executar Calibração';
    mostrarEtapa(4);
});

const optBtn = document.getElementById('optimizeButton');
let optResultsCache = null;
const optProgress = document.getElementById('optProgress');
const optProgressBar = document.getElementById('optProgressBar');
const optProgressCont = document.getElementById('optProgressContainer');
let optTimer = null;

function clearFieldError(el){
    if(!el) return;
    el.classList.remove('border-red-500');
    const err = el.parentNode.querySelector('.field-error');
    if(err) err.remove();
}

function showFieldError(el, msg){
    if(!el) return;
    el.classList.add('border-red-500');
    let err = el.parentNode.querySelector('.field-error');
    if(!err){
        err = document.createElement('div');
        err.className = 'text-xs text-red-600 field-error';
        el.parentNode.appendChild(err);
    }
    err.textContent = msg;
}

function validateOptFields(){
    let valid = true;
    const targetEl = document.getElementById('target');
    const nCompEl = document.getElementById('n_components');
    const clsEl = document.getElementById('classification');
    const valEl = document.getElementById('validation_method');
    const foldsEl = document.getElementById('kfold_splits');

    [targetEl,nCompEl,clsEl,valEl,foldsEl].forEach(clearFieldError);

    if(!targetEl.value){
        showFieldError(targetEl,'Selecione a variável-alvo');
        valid = false;
    }
    const ncVal = parseInt(nCompEl.value);
    if(isNaN(ncVal) || ncVal <= 0){
        showFieldError(nCompEl,'Informe n_components');
        valid = false;
    }
    if(!clsEl.value){
        showFieldError(clsEl,'Selecione o modo de análise');
        valid = false;
    }
    if(!valEl.value){
        showFieldError(valEl,'Informe o método de validação');
        valid = false;
    }
    if(valEl.value === 'KFold'){
        const k = parseInt(foldsEl.value);
        if(isNaN(k) || k <= 1){
            showFieldError(foldsEl,'Informe o número de folds');
            valid = false;
        }
    }
    return valid;
}

optBtn.addEventListener('click', async ()=>{
    if(optResultsCache){
        mostrarEtapa(3);
        return;
    }
    if(!lastParams || !fileInput.files.length) return;
    if(!validateOptFields()) return;

    const fd = new FormData();
    fd.append('file', fileInput.files[0]);
    const rangeArr = lastParams.ranges ? lastParams.ranges.split('-').map(v=>parseFloat(v)) : [];
    const payload = {
        target: document.getElementById('target').value,
        validation_method: document.getElementById('validation_method').value,
        n_components: parseInt(document.getElementById('n_components').value),
        n_bootstrap: parseInt(document.getElementById('n_bootstrap').value) || 0,
        folds: document.getElementById('validation_method').value === 'KFold' ? (parseInt(document.getElementById('kfold_splits').value) || 5) : undefined,
        analysis_mode: document.getElementById('classification').value === 'true' ? 'PLS-DA' : 'PLS-R',
        spectral_range: rangeArr.length === 2 ? rangeArr : undefined,
        preprocessing_methods: lastParams.preprocess_steps.map(p=>p.method)
    };
    fd.append('params', JSON.stringify(payload));
    optBtn.disabled = true;
    optProgressCont.classList.remove('hidden');
    optProgressBar.style.width = '0%';
    optProgress.textContent = 'Iniciando otimização...';
    optTimer = setInterval(async ()=>{
        const stRes = await fetch('/optimize/status');
        if(stRes.ok){
            const st = await stRes.json();
            const pct = st.total ? Math.round((st.current/st.total)*100) : 0;
            optProgressBar.style.width = pct + '%';
            optProgress.textContent = `Executando otimização: ${pct}%`;
        }
    }, 1000);
    const res = await fetch('/optimize', {method:'POST', body: fd});
    clearInterval(optTimer);
    optProgressBar.style.width = '100%';
    if(res.ok){
        const data = await res.json();
        optResultsCache = data.results || [];
        renderDecision(optResultsCache);
        mostrarEtapa(3);
    }else{
        let msg = 'Erro desconhecido';
        if(res.status === 400 || res.status === 422){
            try{ const err = await res.json(); msg = err.detail || msg; }catch(e){ msg = await res.text(); }
        }
        alert('Erro: ' + msg);
    }
    optProgressCont.classList.add('hidden');
    optProgress.textContent = '';
    optBtn.disabled = false;
});

function renderDecision(results){
    const tbl = document.getElementById('decisionTable');
    const isClass = results.some(r => r.RMSECV === null);
    const metricLabel = isClass ? 'Accuracy' : 'RMSECV';
    const header = `<tr><th class="px-4 py-2 border-b">Pré-processamento</th><th class="px-4 py-2 border-b">n_components</th><th class="px-4 py-2 border-b">${metricLabel}</th><th class="px-4 py-2 border-b">R²</th><th class="px-4 py-2 border-b">Validação</th><th class="px-4 py-2 border-b">Faixa usada</th></tr>`;
    tbl.innerHTML = header;
    selectedOpt = null;
    const grouped = {};
    const sorted = [...results].sort((a,b)=>{
        const aval = isClass ? -(a.val_metrics.Accuracy||0) : (a.RMSECV||1e9);
        const bval = isClass ? -(b.val_metrics.Accuracy||0) : (b.RMSECV||1e9);
        return aval - bval;
    });
    sorted.forEach(r=>{
        const prepLabel = preprocessLabels[r.preprocess]||r.preprocess;
        const metric = isClass ? (r.val_metrics.Accuracy||0).toFixed(3) : (r.RMSECV||0).toFixed(3);
        const r2 = r.val_metrics.R2 !== undefined ? Number(r.val_metrics.R2).toFixed(3) : '-';
        const valMethod = r.validation ? r.validation.method : '-';
        const range = r.wl_used && r.wl_used.length ? `${r.wl_used[0]}-${r.wl_used[r.wl_used.length-1]}` : '-';
        const tr = document.createElement('tr');
        tr.classList.add('cursor-pointer');
        tr.dataset.preprocess = r.preprocess;
        tr.dataset.ncomp = r.n_components;
        tr.innerHTML = `<td class="px-4 py-2 border-b">${prepLabel}</td><td class="px-4 py-2 border-b">${r.n_components}</td><td class="px-4 py-2 border-b">${metric}</td><td class="px-4 py-2 border-b">${r2}</td><td class="px-4 py-2 border-b">${valMethod}</td><td class="px-4 py-2 border-b">${range}</td>`;
        tr.addEventListener('click',()=>{
            document.querySelectorAll('#decisionTable tr.bg-green-200').forEach(rw=>rw.classList.remove('bg-green-200'));
            tr.classList.add('bg-green-200');
            selectedOpt = {preprocess: tr.dataset.preprocess, n_components: parseInt(tr.dataset.ncomp)};
        });
        tbl.appendChild(tr);
        if(!grouped[prepLabel]) grouped[prepLabel] = [];
        grouped[prepLabel].push({nc: r.n_components, val: isClass ? r.val_metrics.Accuracy || 0 : r.RMSECV || 0});
    });
    const traces = Object.keys(grouped).map(label=>{
        const arr = grouped[label].sort((a,b)=>a.nc-b.nc);
        return {x: arr.map(a=>a.nc), y: arr.map(a=>a.val), mode:'lines+markers', name: label};
    });
    Plotly.newPlot('decisionChart', traces, {title:`${metricLabel} x n_components`, xaxis:{title:'n_components'}, yaxis:{title:metricLabel}}, {responsive:true});
}

document.getElementById('newAnalysis').addEventListener('click', ()=>{
    mostrarEtapa(1);
});

document.getElementById('continueModel').addEventListener('click', async ()=>{
    if(!selectedOpt){
        mostrarEtapa(4);
        return;
    }
    const btn = document.getElementById('continueModel');
    btn.disabled = true;
    btn.textContent = 'Executando...';
    const fd = new FormData();
    fd.append('file', fileInput.files[0]);
    fd.append('target', targetSelect.value);
    fd.append('n_components', selectedOpt.n_components);
    const clsVal = document.getElementById('classification').value;
    fd.append('classification', clsVal);
    if(clsVal === 'true'){
        fd.append('threshold', document.getElementById('cls_threshold').value);
    }
    fd.append('n_bootstrap', document.getElementById('n_bootstrap').value);
    const valMethod = document.getElementById('validation_method').value;
    fd.append('validation_method', valMethod);
    if(valMethod === 'Holdout'){
        const ts = parseFloat(document.getElementById('test_size').value);
        fd.append('validation_params', JSON.stringify({test_size: ts}));
    } else if(valMethod === 'KFold') {
        const k = parseInt(document.getElementById('kfold_splits').value) || 5;
        fd.append('validation_params', JSON.stringify({n_splits: k, shuffle: true, random_state: 42}));
    }
    const rangesVal = document.getElementById('ranges').value;
    fd.append('spectral_ranges', rangesVal);
    const wlVal = parseInt(document.getElementById('windowLength').value);
    const poVal = parseInt(document.getElementById('polyOrder').value);
    const steps = selectedOpt.preprocess === 'none' ? [] : [{method: selectedOpt.preprocess}];
    const methods = steps.map(step => {
        if(['sg1','sg2'].includes(step.method)){
            return {method: step.method, params:{window_length: wlVal, polyorder: poVal}};
        }
        return {method: step.method};
    });
    if(methods.length) fd.append('preprocess', JSON.stringify(methods));
    const res = await fetch('/analisar', {method:'POST', body: fd});
    btn.disabled = false;
    btn.textContent = 'Continuar';
    if(!res.ok){
        alert('Erro ao executar modelagem final');
        return;
    }
    const data = await res.json();
    currentMetrics = data.metrics;
    lastVip = data.vip;
    lastYReal = data.y_real;
    lastYPred = data.y_pred;
    lastTopVips = data.top_vips;
    lastScores = data.scores;
    lastInterpretacao = data.interpretacao_vips;
    lastResumo = data.resumo_interpretativo;
    lastParams.n_components = selectedOpt.n_components;
    lastParams.preprocess = selectedOpt.preprocess;
    lastParams.preprocess_steps = methods;
    renderMetrics(data.metrics);
    const scoresCard = document.getElementById('scoresCard');
    const confCard = document.getElementById('confMatrixCard');
    scoresCard.classList.add('hidden');
    confCard.classList.add('hidden');
    document.getElementById('realVsPred').innerHTML = '';
    document.getElementById('confMatrix').innerHTML = '';
    if(data.analysis_type === 'PLS-DA' && data.scores){
        scoresCard.classList.remove('hidden');
        const xs = data.scores.map(s => s[0]);
        const ys = data.scores.map(s => s[1] || 0);
        const t = {x: xs, y: ys, mode:'markers', type:'scatter', marker:{color: data.y_real}};
        Plotly.newPlot('realVsPred', [t], {title:'Scores PLS', xaxis:{title:'Comp 1'}, yaxis:{title:'Comp 2'}}, {responsive:true});
        if(data.metrics && data.metrics.ConfusionMatrix){
            confCard.classList.remove('hidden');
            const labels = data.class_mapping ? Object.values(data.class_mapping) : [];
            const z = data.metrics.ConfusionMatrix;
            const heat = {
                z,
                x: labels,
                y: labels,
                type:'heatmap',
                colorscale:'YlGnBu',
                text: z.map(r => r.map(String)),
                texttemplate:'%{text}',
                textfont:{color:'black'}
            };
            const layout = {title:'Matriz de Confusão', xaxis:{title:'Predito'}, yaxis:{title:'Real'}};
            Plotly.newPlot('confMatrix', [heat], layout, {responsive:true});
        }
    } else if(data.y_real && data.y_pred){
        scoresCard.classList.remove('hidden');
        const scatter = {x: data.y_real, y: data.y_pred, mode:'markers', type:'scatter'};
        Plotly.newPlot('realVsPred', [scatter], {title:'y_real vs y_previsto', xaxis:{title:'y_real'}, yaxis:{title:'y_previsto'}}, {responsive:true});
    }
    const trace = {x: data.features, y: data.vip, type:'bar'};
    Plotly.newPlot('vipChart', [trace], {title:'VIP Scores'}, {responsive:true});
    if(data.top_vips) renderTopVips(data.top_vips, data.range_used);
    mostrarEtapa(4);
});

document.getElementById('downloadPdf').addEventListener('click', async ()=>{
    if(!currentMetrics) return;
    const payload = {metrics: currentMetrics, params: lastParams, y_real: lastYReal, y_pred: lastYPred, vip: lastVip, top_vips: lastTopVips, scores: lastScores, interpretacao_vips: lastInterpretacao, resumo_interpretativo: lastResumo};
    const res = await fetch('/report', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
    });
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'relatorio.pdf';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});
</script>
</body>
</html>
